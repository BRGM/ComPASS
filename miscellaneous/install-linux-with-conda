# this will create a new conda environment called *compass*
# to activate the environment: `conda activate compass`
# to remove all that came with that environment: `conda env remove -n compass`
conda create -y -n compass

# use -n option is to tell conda to install packages in *compass* environment
# the other option is to activate compass environment first
conda install -y -n compass --override-channels -c conda-forge numba scipy mpi4py petsc4py make cmake gcc gxx gfortran

# activate compass environment to have CONDA_PREFIX
conda activate compass
echo '#!/bin/sh

# god-awful... but cmake cannot spot gcc-ar for ComPASS
# this seems to be linked to the fact that we set CC to mpicc
# (because of PETSc)
ln -s ${CONDA_PREFIX}/bin/gcc-ar ${CONDA_PREFIX}/bin/ar
' > ${CONDA_PREFIX}/etc/conda/activate.d/setup_ar.sh
echo '#!/bin/sh

# this is used to use flags from mpicc to build against PETSC
# cf. FindPETSC.cmake in cmake/modules from https://github.com/jedbrown
export CC=mpicc
export CXX=mpicxx
export FC=mpifort
export PETSC_DIR=${CONDA_PREFIX}
' > ${CONDA_PREFIX}/etc/conda/activate.d/env_vars.sh
echo '#!/bin/sh

unset CC
unset CXX
unset FC
unset PETSC_DIR
' > ${CONDA_PREFIX}/etc/conda/deactivate.d/env_vars.sh
# reactivate environment to set variables
conda activate compass

# as conda environment is activated it is ok to call python -m pip
python -m pip install scikit-build click PyYAML inept sortedcontainers verstr setuptools_scm

# the use of gitlab-inria int the following assumes:
#   - correct credentials/ssh keys to connect to git@gitlab.inria.fr
#   - you have defined gitlab-inria in your .ssh/config
# you can also use public adresses from https://github.com/BRGM

# -- MeshTools --

# git clone gitlab-inria:charms/MeshTools.git
git clone https://github.com/BRGM/MeshTools.git

cd MeshTools
# developper mode
# python setup.py develop -G "Unix Makefiles" -j $(nproc) -DMESHTOOLS_TRIES_TO_USE_CGAL=OFF
python setup.py install -G "Unix Makefiles" -j $(nproc) -DMESHTOOLS_TRIES_TO_USE_CGAL=OFF
cd ..

# -- ComPASS --

# git clone gitlab-inria:charms/ComPASS.git
git clone https://github.com/BRGM/ComPASS.git

cd ComPASS
# check the physics you want to build, here only water2ph physics will be built
# developper mode
# python setup.py develop -G "Unix Makefiles" -j $(nproc) -DComPASS_WITH_water2ph_PHYSICS=ON
python setup.py install -G "Unix Makefiles" -j $(nproc) -DComPASS_WITH_water2ph_PHYSICS=ON
cd ..
